# RDB持久化

将数据以二进制文件的形式存储到硬盘里 .

#### 持久化

因为Redis服务器将数据存储在内存里面 , 而一旦服务器被关闭 , 或者运行服务器的主机本身被关闭的话 , 存储在内存里面的数据就会消失不见 .

如果仅仅是将Redis用作缓存的话 , 这种数据丢失带来的问题并不是非常大 , 只要重启 , 然后将数据放到缓存里就可以了 , 但是如果将Redis用作数据库的话 , 那么数据丢失就不能接受了 .

为了在Redis服务器关闭时 , 仍然保留数据库中的数据 , Redis提供了RDB和AOF两种持久化功能 , 这两个功能可以将存储在内存里面的数据库数据以文件的形式保存到硬盘里面 , 这样的话 , 即使服服务器关闭 , 已经保存到硬盘里面的数据也不会丢失 .

除此之外 , 服务器也可以在重新启动时 , 通过载入持久化文件来还原服务器在关闭之前的数据库数据 . 或者使用持久化文件来进行数据备份、数据迁移等工作 .

#### RDB持久化

RDB持久化功能可以将服务器包含的所有数据库数据以二进制文件的形式保存到硬盘里面 .

![](/assets/rdbchijiuhua.png)

而通过在服务器启动时载入RDB文件 , 服务器可以根据RDB文件的内容 , 还原服务器原有的数据库数据 .

![](/assets/rdbchijiuhua2.png)

#### 创建RDB文件

在Redis服务器创建RDB文件的情况中 , 以下三种是最常见的 :

* 服务器执行客户端发送的SAVE命令
* 服务器执行客户端发送的BGSAVE的命令
* 使用save配置选项设置的自动保存条件被满足 , 服务器自动执行BGSAVE

在这三种创建RDB文件的情况中 , 前两种情况需要用户手动执行 , 而第三种情况则是由Redsi服务器自动执行 .

### 手动创建RDB文件

客户端发送SAVE或者BGSAVE .

#### SAVE命令

通过使用客户端向服务器发送SAVE命令 , 可以命令服务器去创建一个新的RDB文件 :

```
redis> SAVE
```

![](/assets/rdb3.png)在执行SAVE命令的过程中\(也即是创建RDB文件的过程中\) , Redis服务器将被阻塞 , 无法处理客户端发送的命令请求 , 只有在SAVE命令执行完毕之后\(也即是RDB文件创建完毕之后\) , 服务器才会重新开始处理客户端发送的命令请求 .

如果RDB文件已经存在 , 那么服务器将自动使用新的RDB文件去代替旧的文件.

SAVE命令的复杂度是O\(N\) , N为服务器中 , 所有数据库包含的键值对数量总和 .

#### BGSAVE命令

执行BGSAVE命令同样可以创建一个新的RDB文件 , 这个命令和SAVE命令的区别在于 , BGSAVE不会造成Redis服务器阻塞 . 在执行BGSAVE命令的过程中 , Redis服务器仍然可以正常地处理其他客户端发送的命令请求 . 

BGSAVE命令不会造成服务器阻塞的原因在于 : 

* 当Redis服务器接收到BGSAVE命令的时候 , 它不会自己来创建RDB文件 , 而是通过fork\(\)来生成一个子进程 , 然后由子进程负责创建RDB文件 , 而自己则继续处理客户端的命令请求 ; 
* 当子进程创建好RDB文件并退出时 , 它会向父进程\(也即是负责处理命令请求的Redis服务器\)发送一个信号 , 告知它RDB文件已经创建完毕 ; 
* 最后Redis服务器\(父进程\)接收子进程创建的RDB文件 , BGSAVE执行完毕 . 

BGSAVE是一个异步命令 , 发送命令的客户端会立即得到回复 , 而实际的操作在回复之后才开始 : 

```
redis> BGSAVE
Background saving started
```

BGSAVE命令的复杂度和SAVE一样 , 都是O\(N\) , N为所有数据库包含的键值对数量总和 . 

